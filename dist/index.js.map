{"version":3,"file":"index.js","sources":["../src/compile.ts","../src/dep.ts","../src/reactive.ts","../src/observer.ts","../src/nexttick.ts","../src/watcher.ts","../src/index.ts"],"sourcesContent":["export function compileHtmlToFunction(template:string):(data:object|Array<any>) => string {\r\n    // const exp = \r\n    const queue = []\r\n    let matched = false\r\n    let matchedStr = \"\"\r\n    for (let i = 0; i < template.length; i++) {\r\n        const current = template.charAt(i)\r\n        if (current === \"{\") {\r\n            matched = true\r\n            queue.push((matchedStr))\r\n            matchedStr = \"\"\r\n        } else if (current === \"}\") {\r\n            matched = false\r\n            queue.push(createGetter(matchedStr))\r\n            matchedStr = \"\"\r\n        } else {\r\n            matchedStr += current\r\n        }\r\n    }\r\n    matchedStr && queue.push(matchedStr)\r\n    return function compiler(data:object|Array<any>):string {\r\n        let str = \"\"\r\n        for (let i = 0; i < queue.length; i++) {\r\n            str += (typeof queue[i] === \"function\" ?\r\n            queue[i](data) :\r\n            queue[i])\r\n        }\r\n        return str\r\n    }\r\n}\r\n\r\nfunction createGetter(exp) {\r\n    return function getValue(data) {\r\n        const arr = exp.split(\".\")\r\n        let value = data\r\n        for (let i = 0; i < arr.length; i++) {\r\n            value = value[arr[i]]\r\n        }\r\n        return value\r\n    }\r\n}\r\n","import { Watcher } from \"./watcher\"\r\n\r\nlet target:Watcher = null\r\n\r\nexport class Dep {\r\n    watchers: Array<Watcher>\r\n    constructor() {\r\n        this.watchers = []\r\n    }\r\n    addSub(watcher: Watcher) {\r\n        this.watchers.push(watcher)\r\n    }\r\n    removeSub() {\r\n\r\n    }\r\n    depend() {\r\n        target && target.addDep(this)\r\n    }\r\n    //  通知更新\r\n    notify() {\r\n        for (let i = 0; i < this.watchers.length; i++) {\r\n            this.watchers[i].update()\r\n        }\r\n    }\r\n}\r\n\r\nexport function setTarget(watcher: Watcher|null) {\r\n    target = watcher\r\n}","import { Dep } from \"./dep\"\r\n\r\nexport function reactive(data:object|Array<any>):any {\r\n    const dep = new Dep()\r\n    const handler = {\r\n        get(target, key) {\r\n            dep.depend()\r\n            return target[key]\r\n        },\r\n        set(target, key, value) {\r\n            //  数组发生改变的时候会触发两次，length触发一次，内容改变触发一次\r\n            const old = target[key]\r\n            if (old === value) {\r\n                return true\r\n            }\r\n            target[key] = value\r\n            dep.notify()\r\n            return true\r\n        }\r\n    }\r\n    return new Proxy(data, handler)\r\n}","import { reactive } from \"./reactive\";\r\n\r\nexport function observe(data:object|Array<any>):any {\r\n    // return reactive(data)\r\n    // console.log(data)\r\n    Object.entries(data).forEach(([key, value]) => {\r\n        if (Array.isArray(value) || {}.toString.call(value) === \"[object Object]\") {\r\n            data[key] = observe(value)\r\n        }\r\n    })\r\n    return reactive(data)\r\n}","import { Watcher } from \"./watcher\"\r\n\r\nconst watcherQueue:Array<Watcher> = []\r\nlet waiting = false\r\n\r\nfunction nextTick() {\r\n    const p = Promise.resolve()\r\n    p.then(() => {\r\n        waiting = false\r\n        for (let i = 0; i < watcherQueue.length; i++) {\r\n            const watcher = watcherQueue[i]\r\n            watcher.run()\r\n        }\r\n        console.log(\"afterupdated\")\r\n    })\r\n}\r\n\r\nfunction clearWatcherQueue() {\r\n    watcherQueue.splice(0, watcherQueue.length)\r\n}\r\n\r\nexport function addWatcher(watcher: Watcher) {\r\n    if (!watcherQueue.includes(watcher)) {\r\n        watcherQueue.push(watcher)\r\n    }\r\n    if (!waiting) {\r\n        waiting = true\r\n        nextTick()\r\n    }\r\n}","import { Dep, setTarget } from \"./dep\";\r\nimport {\r\n    addWatcher\r\n} from \"./nexttick\"\r\nimport View from \".\";\r\nlet uid = 0\r\n\r\nexport class Watcher {\r\n    render:(data:any)=>string\r\n    data: any\r\n    id:number\r\n    vm:View\r\n    constructor(render:(data:any)=>string, data: any, vm:View) {\r\n        this.render = render\r\n        this.data = data\r\n        this.id = uid++\r\n        this.vm = vm\r\n        this.init()\r\n    }\r\n    init() {\r\n        setTarget(this)\r\n        this.run()\r\n        setTarget(null)\r\n    }\r\n    addDep(dep: Dep) {\r\n        dep.addSub(this)\r\n    }\r\n    \r\n    update() {\r\n        addWatcher(this)\r\n    }\r\n\r\n    run() {\r\n        const value = this.render(this.data)\r\n        this.vm._update(value)\r\n    }\r\n}","import { compileHtmlToFunction } from \"./compile.js\"\r\nimport { observe } from \"./observer.js\"\r\nimport { Watcher } from \"./watcher.js\"\r\n\r\n\r\nexport default class View {\r\n    el: HTMLElement\r\n    data:any\r\n    constructor(opts) {\r\n        this.el = null\r\n        this.data = null\r\n        this.init(opts)\r\n    }\r\n\r\n    init(opts) {\r\n        const {\r\n            el,\r\n            data\r\n        } = opts\r\n        this.data = observe(data)\r\n        this.el = document.getElementById(el)\r\n        const template = this.getTemplate(this.el)\r\n        const complier = compileHtmlToFunction(template)\r\n        new Watcher(complier, this.data, this)\r\n    }\r\n\r\n    getTemplate(el:HTMLElement):string {\r\n        return el.innerHTML\r\n    }\r\n\r\n    _update(value:string) {\r\n        this.el.innerHTML = value\r\n    }\r\n\r\n\r\n}"],"names":[],"mappings":"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"}